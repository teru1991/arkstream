name: Vault Secret Check

on:
  workflow_dispatch:
  workflow_call:  # âœ… ä»–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

jobs:
  check-secrets:
    name: ğŸ›¡ï¸ Check Required Secrets from Vault
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Vault CLI
        run: |
          curl -fsSL https://releases.hashicorp.com/vault/1.15.2/vault_1.15.2_linux_amd64.zip -o vault.zip
          unzip -o vault.zip
          sudo mv vault /usr/local/bin/vault
          vault --version

      - name: ğŸ” Verify Secrets from Vault
        env:
          VAULT_ADDR: ${{ secrets.ARKSTREAM_VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.ARKSTREAM_VAULT_TOKEN }}
        run: |
          required_keys=("POSTGRES_PASSWORD" "MONGO_URI" "KAFKA_BROKER")
          for key in "${required_keys[@]}"; do
            if ! vault kv get -mount=secret -field="$key" arkstream/testenv &> /dev/null; then
              echo "âŒ $key not found in Vault"
              vault kv get -mount=secret arkstream/testenv || true
              exit 1
            fi
          done
          echo "âœ… All required secrets exist in Vault"
