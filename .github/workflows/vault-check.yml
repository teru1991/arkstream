name: Vault Secret Check

on:
  workflow_dispatch:

jobs:
  check-vault-secrets:
    name: ğŸ›¡ï¸ Check Vault Secrets (Dev Server)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Vault CLI
        run: |
          curl -fsSL https://releases.hashicorp.com/vault/1.15.2/vault_1.15.2_linux_amd64.zip -o vault.zip
          # ğŸ‘‡ vault ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ï¼ˆunzipã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
          [ -d vault ] && rm -rf vault
          unzip -o vault.zip
          sudo mv vault /usr/local/bin/vault
          vault --version
      

      - name: ğŸš€ Start Vault Dev Server (background)
        run: |
          nohup vault server -dev -dev-root-token-id="root-token" > vault.log 2>&1 &
          sleep 5
        env:
          VAULT_DEV_ROOT_TOKEN_ID: root-token

      - name: ğŸ”‘ Put test secrets into Vault
        run: |
          export VAULT_ADDR=http://127.0.0.1:8200
          export VAULT_TOKEN=root-token
          vault kv put secret/arkstream/testenv \
            POSTGRES_PASSWORD=your_postgres_password \
            MONGO_URI=your_mongo_uri \
            KAFKA_BROKER=your_kafka_broker

      - name: âœ… Check required secrets
        run: |
          export VAULT_ADDR=http://127.0.0.1:8200
          export VAULT_TOKEN=root-token
          required_keys=("POSTGRES_PASSWORD" "MONGO_URI" "KAFKA_BROKER")
          for key in "${required_keys[@]}"; do
            if ! vault kv get -mount=secret -field="$key" arkstream/testenv &> /dev/null; then
              echo "âŒ $key not found in Vault"
              vault kv get -mount=secret arkstream/testenv || true
              exit 1
            fi
          done
          echo "âœ… All required secrets exist in Vault"
